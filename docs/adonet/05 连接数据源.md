# 连接数据源

> 任何数据库应用程序的一项主要功能是连接数据源并检索数据源中包含的数据。 ADO.NET 的 .NET Framework 数据提供程序充当应用程序和数据源之间的桥梁，使你可以执行命令以及使用 DataReader 或 DataAdapter 检索数据。 任何数据库应用程序的一项关键功能是更新数据库中存储的数据的能力。 在 ADO.NET 中，更新数据时会使用 DataAdapter、DataSet 和 Command 对象；此外，还可能会使用事务。

## 一、连接数据源

### 01 建立连接
在 ADO.NET 中，通过在连接字符串中提供必要的身份验证信息，使用 `Connection` 对象来连接到某个特定数据源， 使用的 `Connection` 对象类型取决于数据源的类型。

随 .NET Framework 提供的每个数据提供程序都具有一个 DbConnection 对象：

- 适用于 OLE DB 的 .NET Framework 数据提供程序包括一个 [OleDbConnection](https://learn.microsoft.com/zh-cn/dotnet/api/system.data.oledb.oledbconnection) 对象；
- 适用于 SQL Server 的 .NET Framework 数据提供程序包括一个 [SqlConnection](https://learn.microsoft.com/zh-cn/dotnet/api/system.data.sqlclient.sqlconnection) 对象；
- 适用于 ODBC 的 .NET Framework 数据提供程序包括一个 [OdbcConnection](https://learn.microsoft.com/zh-cn/dotnet/api/system.data.odbc.odbcconnection) 对象
- 适用于 Oracle 的 .NET Framework 数据提供程序包括一个 [OracleConnection](https://learn.microsoft.com/zh-cn/dotnet/api/system.data.oracleclient.oracleconnection) 对象。

=== "SQL Server"
	```csharp
	// Assumes connectionString is a valid connection string.  
	using (SqlConnection connection = new SqlConnection(connectionString))  
	{  
	    connection.Open();  
	    // Do work here.  
	}
	```

=== "OLE DB"
	```csharp
	// Assumes connectionString is a valid connection string.  
	using (OleDbConnection connection =
	  new OleDbConnection(connectionString))  
	{  
	    connection.Open();  
	    // Do work here.  
	}
	```

=== "ODBC"
	```csharp
		// Assumes connectionString is a valid connection string.  
		using (OdbcConnection connection =
		  new OdbcConnection(connectionString))  
		{  
		    connection.Open();  
		    // Do work here.  
		}
		```

=== "Oracle"
	```csharp
	// Assumes connectionString is a valid connection string.  
	using (OracleConnection connection =
	  new OracleConnection(connectionString))  
	{  
	    connection.Open();  
	    // Do work here.  
	}  
	OracleConnection nwindConn = new OracleConnection("Data Source=MyOracleServer;Integrated Security=yes;");  
	nwindConn.Open();
	```

### 02 关闭连接
建议在使用完连接时一定要关闭连接，以便连接可以返回池。

- 使用 `using` 语句，`using` 语句可确保正确使用 IDisposable 实例；
- 调用连接对象的 `Close` 或 `Dispose` 方法

不是显式关闭的连接可能不会添加或返回到池中。例如，如果连接已超出范围但没有显式关闭，则仅当达到最大池大小而该连接仍然有效时，该连接才会返回到连接池中。

## 二、连接事件

### 01 Connection连接事件
所有 .NET Framework 数据提供程序中的 Connection 对象有两个事件，可用于从数据源中检索信息性消息或确定 Connection 的状态是否已被更改。

| 事件        | 说明                                                                        |
|:----------- |:--------------------------------------------------------------------------- |
| InfoMessage | 当从数据源中返回信息性消息时发生。 信息性消息是数据源中不会引发异常的消息。 |
| StateChange | 当 Connection 的状态更改时发生。                                                                            |

### 02 使用InfoMessage事件
SqlConnection 对象的 InfoMessage 事件从 SQL Server 数据源中检索警告和信息性消息。

> 从数据源返回的严重程度为 11 到 16 的错误将引发异常。 但是，InfoMessage 事件可用于从数据源中获取与错误无关联的消息。 对于 Microsoft SQL Server，任何严重程度等于或小于 10 的错误都将被视为信息性消息，将使用 InfoMessage 事件来捕获。

InfoMessage 事件接收 `SqlInfoMessageEventArgs` 对象，该对象在其 `Errors` 属性中包含来自数据源的消息的集合。

示例：
```csharp
// Assumes that connection represents a SqlConnection object.  
connection.InfoMessage += new SqlInfoMessageEventHandler(OnInfoMessage);  
  
protected static void OnInfoMessage(object sender, SqlInfoMessageEventArgs args)  
{  
	foreach (SqlError err in args.Errors)  
	{  
		Console.WriteLine(  
			"The {0} has received a severity {1}, state {2} error number {3}\n" +  
			"on line {4} of procedure {5} on server {6}:\n{7}",  
			err.Source, 
			err.Class, 
			err.State, 
			err.Number, 
			err.LineNumber,
			err.Procedure, 
			err.Server, 
			err.Message);  
	}  
}
```

### 03 使用StateChange事件
StateChange 事件在 Connection 的状态更改时发生。 

StateChange 事件接收 `StateChangeEventArgs`，使你能够使用 `OriginalState` 和 `CurrentState` 属性来确定 Connection 状态的更改。 

- OriginalState 属性是一个 ConnectionState 枚举，指示更改前的 Connection 状态；
- CurrentState 属性是一个 ConnectionState 枚举，指示更改后的 Connection 状态。

示例：
```csharp
// Assumes connection represents a SqlConnection object.  
connection.StateChange  += new StateChangeEventHandler(OnStateChange);  

protected static void OnStateChange(object sender, StateChangeEventArgs args)  
{  
	Console.WriteLine(  
		"The current Connection state has changed from {0} to {1}.",  
		args.OriginalState, 
		args.CurrentState);  
}
```


## 三、连接字符串
